render_question_panel <- function(
  inputId,
  questions
) {
  checkmate::assert_string(inputId)
  checkmate::assert_list(questions)

  categories <- purrr::map_chr(
    questions,
    \(e) {
      e$category %||% NA_character_
    }
  ) |>
    unique()

  stopifnot(!any(is.na(categories)))

  category_panels <- purrr::map(
    categories,
    \(category) {

      questions_by_category <- get_questions_by_category(questions, category)

      buttons <- purrr::map(
        questions_by_category,
        \(e) {
          render_question_panel_button(inputId, e)
        }
      )

      header <- shiny::tags$div(
        class = "qz-question-panel__category-label",
        shiny::tags$span(category)
      )

      shiny::tags$div(
        class = "qz-question-panel__category-buttons",
        header,
        shiny::tags$div(
          class = "qz-question-panel__question-choices",
          !!!buttons
        )
      )
    }
  ) |>
    shiny::tagList()

  shiny::tagList(
    shiny::tags$div(
      class = "qz-question-panel",
      !!!category_panels
    )
  )
}



render_question_panel_button <- function(
    inputId,
    question
) {
  checkmate::assert_string(inputId)
  checkmate::assert_class(question, "QuestionMultipleChoice")

  btn_class <- if (question$is_answered && question$is_solved) {
    "btn-success"
  } else if (question$is_answered) {
    "btn-danger"
  } else {
    "btn-secondary"
  }

  shiny::tags$button(
    question$value,
    "id" = question$id,
    "type" = "button",
    "class" = paste("btn btn-default action-button", btn_class),
    "onclick" = make_question_panel_button_onclick_handler(inputId, question$id)
  )
}



make_question_panel_button_onclick_handler <- function(
    inputId,
    id_question
) {
  sprintf("
    Shiny.setInputValue('%s', {
      id_question: '%s'
    }, {priority: 'event'})
  ", inputId, id_question)
}



render_mc_question <- function(
    inputId,
    inputId_backButton,
    question
) {
  checkmate::assert_string(inputId)
  checkmate::assert_class(question, "QuestionMultipleChoice")

  prompt      <- question$prompt
  id_question <- question$id
  options     <- question$mc_options

  show_solution      <- question$is_answered
  id_option_correct  <- question$id_option_correct
  id_option_answered <- question$id_option_answered

  buttons <- purrr::map(
    options,
    \(e) {
      class <- if (show_solution && e$id == id_option_correct) {
        "btn-success"
      } else if (show_solution && e$id == id_option_answered) {
        "btn-danger"
      } else {
        "btn-secondary"
      }

      render_mc_option(
        inputId     = inputId,
        label       = e$label,
        id_question = id_question,
        id_option   = e$id,
        class       = class
      )
    }
  ) |>
    shiny::tagList()

  shiny::tags$div(
    class = "qz-mc-wrapper",
    shiny::tags$div(
      class = "qz-mc-question",
      shiny::tags$div(
        class = "qz-mc-question__prompt",
        shiny::tags$span(prompt)
      ),
      shiny::tags$div(
        class = "qz-mc-question__options",
        buttons
      )
    ),
    shiny::tags$div(
      class = "qz-back-button",
      shiny::tags$button(
        "Zur√ºck",
        "id" = inputId_backButton,
        "type" = "button",
        "class" = "qz-mc-option btn btn-default action-button btn-secondary",
        "onclick" = make_back_button_onclick_handler(inputId_backButton, id_question)
      )
    )
  )
}



render_mc_option <- function(
    inputId,
    label,
    id_question,
    id_option,
    class = NULL
) {

  shiny::tags$button(
    label,
    "id" = id_option,
    "type" = "button",
    "class" = paste("qz-mc-option btn btn-default action-button btn-secondary", class),
    "onclick" = make_mc_option_onclick_handler(inputId, id_question, id_option)
  )
}



make_mc_option_onclick_handler <- function(
    inputId,
    id_question,
    id_option
) {
  sprintf("
    Shiny.setInputValue('%s', {
      id_question: '%s',
      id_option: '%s'
    }, {priority: 'event'})
  ", inputId, id_question, id_option)
}



make_back_button_onclick_handler <- function(
    inputId,
    id_question
) {
  sprintf("
    Shiny.setInputValue('%s', {
      id_question: '%s'
    }, {priority: 'event'})
  ", inputId, id_question)
}
